

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>


<!-- start added 2025-04-14   å¢åŠ å¯¹markdownä¸­å…¬å¼çš„æ”¯æŒ -->
<script>
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
    },
    options: {
        ignoreHtmlClass: "tex2jax_ignore|mathjax_ignore",
        processHtmlClass: "tex2jax_process|mathjax_process|math|output_area"
    }
};
</script>
<script defer="defer" src="https://fastly.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- end added 2025-04-14   å¢åŠ å¯¹markdownä¸­å…¬å¼çš„æ”¯æŒ -->


<!-- start added 2025-08-06   å¢åŠ å¯¹mermaidå›¾çš„æ”¯æŒ -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        flowchart: { useMaxWidth: true }
    });
});
</script>
<!--  end added 2025-08-06   å¢åŠ å¯¹mermaidå›¾çš„æ”¯æŒ -->




  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>æ¨¡å‹å‚æ•°è®¡ç®— &mdash; æ–°æºª-gordon V2025.11 æ–‡æ¡£</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="ç´¢å¼•" href="../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../search.html" />
    <link rel="next" title="TOPSè®¡ç®—" href="calc_TOPS.html" />
    <link rel="prev" title="é€šç”¨" href="normal.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>
  <script src="../../_static/js/jquery.min.js"></script>


<!-- è¯„è®ºæ’ä»¶ gittalk start -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
<!-- è¯„è®ºæ’ä»¶ gittalk end -->


</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> æ–°æºª-gordon
          

          
          </a>

          
            
            
              <div class="version">
                V2025.11
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">æ€§èƒ½&amp;è°ƒä¼˜</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../normal.html">å¸¸ç”¨</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../indicator.html">å¸¸è§æŒ‡æ ‡</a></li>
<li class="toctree-l2"><a class="reference internal" href="../normal.html">å¸¸ç”¨</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../GPU.html">GPU</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="normal.html">é€šç”¨</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">æ¨¡å‹å‚æ•°è®¡ç®—</a></li>
<li class="toctree-l3"><a class="reference internal" href="calc_TOPS.html">TOPSè®¡ç®—</a></li>
<li class="toctree-l3"><a class="reference internal" href="calc_VRAM.html">GPUæ˜¾å­˜è®¡ç®—</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../HTTP.html">HTTP</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../sla.html">SLA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stress_testing.html">å‹åŠ›æµ‹è¯•</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../stress_testings/normal.html">å¸¸ç”¨</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../stress_testings/normals/normal.html">å¸¸ç”¨</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../stress_testings/normals/concept.html">å‹æµ‹å®šä¹‰</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../stress_testings/normals/qps.html">QPS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../system.html">ç³»ç»Ÿçº§åˆ«ä¼˜åŒ–ç›¸å…³</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../systems/tune_file.html">æ€§èƒ½ç›¸å…³</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../systems/tune_tool.html">ä¼˜åŒ–å·¥å…·</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../systems/tools/SystemTap.html">SystemTap</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../systems/tune_tmp.html">ä¼˜åŒ–ç›¸å…³ä¸´æ—¶</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tool.html">å·¥å…·</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/simple.html">ç®€å•å·¥å…·</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/webbench.html">webbenchçš„ä½¿ç”¨</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/ab.html">Apache Bench(ab)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/http_load.html">http_loadå‘½ä»¤ä½¿ç”¨æ–¹æ³•</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/siege.html">siegeå‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/locust.html">Locust</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/wrk.html">wrkå‘½ä»¤</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/hey.html">hey å‘½ä»¤</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/ali.html">ali</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/simples/ali.html#vegeta">vegeta</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/tsung.html">Tsungä½¿ç”¨æ–‡æ¡£</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_introduce.html">ç®€å•ä»‹ç»</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_usage.html">ç®€å•ç”¨æ³•</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_advance.html">é«˜çº§é…ç½®</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_config.html">tsungå‚è€ƒæ–‡æ¡£è¯´æ˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_report.html">tsungå‚è€ƒæ–‡æ¡£â€”â€”æŠ¥å‘Šå›¾è¡¨å«ä¹‰è¯´æ˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_practice.html">Tsungå‹æµ‹å®è·µ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung-1.0-dtd.html">tsung-1.0.dtd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_question.html">å¸¸è§é—®é¢˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/tsungs/tsung_other.html">å…¶ä»–å‹æµ‹å·¥å…·</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/jmeter.html">Apache JMeter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/loadRunner.html">LoadRunner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/TCPBurn.html">TCPBurn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/cloudPlatform.html">äº‘å¹³å°</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/other.html">å…¶ä»–</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tools/others/k6.html">k6</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../observe.html">æ€§èƒ½è§‚å¯Ÿ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../observes/cpu.html">CPU&amp;å†…å­˜ä½¿ç”¨æƒ…å†µæŸ¥çœ‹</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">æ–°æºª-gordon</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../normal.html">å¸¸ç”¨</a> &raquo;</li>
        
          <li><a href="../GPU.html">GPU</a> &raquo;</li>
        
      <li>æ¨¡å‹å‚æ•°è®¡ç®—</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/normals/GPUs/calc_param.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            <nav id="local-table-of-contents" role="navigation" aria-labelledby="local-table-of-contents-title">
              <h4 id="local-table-of-contents-title">On This Page</h4>
              <ul>
<li><a class="reference internal" href="#">æ¨¡å‹å‚æ•°è®¡ç®—</a><ul>
<li><a class="reference internal" href="#id2">ğŸ“Œ é€šç”¨è¯´æ˜</a></li>
<li><a class="reference internal" href="#id3">ğŸ“Œ ä¼°ç®—çº§å‚æ•°è®¡ç®—</a><ul>
<li><a class="reference internal" href="#id4">å…¬å¼</a></li>
<li><a class="reference internal" href="#id5">ç¤ºä¾‹</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">ğŸ“Œ æ ‡å‡†å‚æ•°è®¡ç®—</a><ul>
<li><a class="reference internal" href="#id7">å‚æ•°è®¡ç®—å…¬å¼</a><ul>
<li><a class="reference internal" href="#id8">æ€»å…¬å¼ç»“æ„</a></li>
<li><a class="reference internal" href="#embedding">1.è¯åµŒå…¥å±‚ï¼ˆEmbeddingï¼‰</a></li>
<li><a class="reference internal" href="#transformer-block-n">2.Transformer Block Ã— N å±‚</a><ul>
<li><a class="reference internal" href="#a-self-attention">A.æ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰</a></li>
<li><a class="reference internal" href="#b-feed-forward-network-ffn">B.å‰é¦ˆç½‘ç»œï¼ˆFeed-Forward Network, FFNï¼‰</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lm-head">3.è¾“å‡ºå±‚ï¼ˆLM Headï¼‰</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mistral-7b">ç¤ºä¾‹ï¼šMistral 7B å‚æ•°è®¡ç®—</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gqa">ğŸ“Œ ä½¿ç”¨GQAæ—¶çš„å‚æ•°è®¡ç®—</a><ul>
<li><a class="reference internal" href="#id9">å®šä¹‰ï¼šGQA æ˜¯ä»€ä¹ˆ</a></li>
<li><a class="reference internal" href="#id10">ä¸ºä»€ä¹ˆä½¿ç”¨ GQAï¼Ÿ</a></li>
<li><a class="reference internal" href="#id11">GQA åœ¨å‚æ•°è®¡ç®—ä¸­çš„ä½“ç°</a></li>
<li><a class="reference internal" href="#id12">ç¤ºä¾‹è®²è§£â€”â€”ä»¥ä¸Šé¢çš„ Mistral 7B ç¤ºä¾‹åˆ†æ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#qwen2-5-3b">ç¤ºä¾‹-Qwen2.5-3B</a><ul>
<li><a class="reference internal" href="#id13">æ¨¡å‹ç»“æ„</a></li>
<li><a class="reference internal" href="#id14">å‚æ•°åˆ†æ</a></li>
<li><a class="reference internal" href="#id15">å‚æ•°è®¡ç®—</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>æ¨¡å‹å‚æ•°è®¡ç®—<a class="headerlink" href="#id1" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h1>
<section id="id2">
<h2>ğŸ“Œ é€šç”¨è¯´æ˜<a class="headerlink" href="#id2" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h2>
<ul class="simple">
<li><p>åŸºæœ¬å‚æ•°ï¼š</p>
<ul>
<li><p>H: hidden_size(éšè—å±‚å¤§å°)</p></li>
<li><p>L: num_layers(Transformerå±‚æ•°)</p></li>
<li><p>V: vocab_size(è¯è¡¨å¤§å°)</p></li>
<li><p>M: ffn_mult: FFN ä¸­é—´å±‚ä¸éšè—å±‚ä¹‹é—´çš„ç³»æ•°</p>
<ul>
<li><p>ffn_dim: FFN ä¸­é—´å±‚çš„ç»´åº¦å¤§å°</p>
<ul>
<li><p>ffn_dim = M Ã— H</p></li>
</ul>
</li>
<li><p>è¯´æ˜</p>
<ul>
<li><p>GPT ç³»åˆ—æ¨¡å‹ä¸­ ffn_mult é€šå¸¸ä¸º 4.0</p></li>
<li><p>LLaMA ç³»åˆ—ä¸­ä¸€èˆ¬ä½¿ç”¨ 3.5</p></li>
<li><p>ä¸€äº›è½»é‡åŒ–æ¨¡å‹å¯èƒ½ä¼šä½¿ç”¨æ›´å°çš„å€¼ï¼ˆå¦‚ 2.0ï¼‰</p></li>
<li><p>è¯´æ˜ï¼šä½†qwenå¥½åƒæ˜¯5.375, è€Œdeepseekæ˜¯2.6875</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Self Attention å‚æ•°:</p>
<ul>
<li><p>å¤šå¤´æ³¨æ„åŠ›</p>
<ul>
<li><p>head_dim: å¤šå¤´æ³¨æ„åŠ›çš„å•Head ç»´åº¦</p></li>
<li><p>num_heads: å¤šå¤´æ³¨æ„åŠ›çš„Headæ•°</p></li>
<li><p>è¯´æ˜ï¼š</p>
<ul>
<li><p>H = head_dim * num_heads</p></li>
</ul>
</li>
</ul>
</li>
<li><p>K/V Cache</p>
<ul>
<li><p>æ™®é€š(MHA)æƒ…å†µ</p>
<ul>
<li><p>num_kv_heads: K/V çš„Headæ•°</p></li>
<li><p>kv_dim: K/V ç»´åº¦</p>
<ul>
<li><p>= num_kv_heads Ã— head_dim</p></li>
</ul>
</li>
<li><p>è¯´æ˜ï¼š</p>
<ul>
<li><p>H = kv_dim * num_kv_heads</p></li>
</ul>
</li>
</ul>
</li>
<li><p>GQAçš„æƒ…å†µ</p>
<ul>
<li><p>è¯´æ˜ï¼š</p>
<ul>
<li><p>Q ä½¿ç”¨æ‰€æœ‰çš„ attention headsï¼ˆå¦‚ 32ï¼‰</p></li>
<li><p>K/V åªç”¨éƒ¨åˆ† headsï¼ˆå¦‚ 8ï¼‰</p></li>
<li><p>è¿™æ ·å°±é™ä½äº† KV-cache çš„å­˜å‚¨éœ€æ±‚å’Œè¯»å–å¼€é”€</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="id3">
<h2>ğŸ“Œ ä¼°ç®—çº§å‚æ•°è®¡ç®—<a class="headerlink" href="#id3" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h2>
<section id="id4">
<h3>å…¬å¼<a class="headerlink" href="#id4" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul class="simple">
<li><p>é‚£ä¹ˆæ€»å‚æ•°(ä¸è€ƒè™‘GQA)è¿‘ä¼¼ä¸ºï¼š</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Total â‰ˆ V Ã— H                  ï¼ˆè¯åµŒå…¥ï¼‰
            + L Ã— 4HÂ²      ï¼ˆTransformerå±‚ Self-Attentionï¼‰
            + L Ã— 3MHÂ²     ï¼ˆTransformerå±‚ FFN)
       + V Ã— H                 ï¼ˆè¾“å‡ºå±‚ï¼‰
</pre></div>
</div>
</section>
<section id="id5">
<h3>ç¤ºä¾‹<a class="headerlink" href="#id5" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul class="simple">
<li><p>å‚æ•°</p>
<ul>
<li><p>H = 4096</p></li>
<li><p>V = 32000</p></li>
<li><p>L = 32</p></li>
<li><p>ffn_dim = M*H = 3.5 * 4096= 14336</p></li>
</ul>
</li>
<li><p>æ€»å‚æ•°</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>= 32000 * 4096 + 32 *(4*4096^2 + 3*4096^2*3.5) + 4096*32000
= 2 * 32000 * 4096 + 32 *(4*4096^2 + 3*4096^2*3.5)
= 2 * 32000 * 4096 + 32 * 4096^2 * (4 + 3*3.5)
= 2 * 32000 * 4096 + 32 * 4096^2 * 14.5
= 250M + 7.25B
= 7.5B
æ³¨æ„: 
    1. åªæœ‰åœ¨å­˜å‚¨æ—¶ï¼Œå•ä½Bæ‰ç”¨ 1024 * 1024 * 1024
    2. è®¡ç®—å‚æ•°é‡æ—¶ï¼Œå•ä½Båº”è¯¥æ˜¯1000*1000*1000
æ‰€ä»¥: 7.5B = 7.5 * (1024*1024*1024)/ (1000*1000*1000)
          â‰ˆ 8.053B
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h2>ğŸ“Œ æ ‡å‡†å‚æ•°è®¡ç®—<a class="headerlink" href="#id6" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h2>
<section id="id7">
<h3>å‚æ•°è®¡ç®—å…¬å¼<a class="headerlink" href="#id7" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<section id="id8">
<h4>æ€»å…¬å¼ç»“æ„<a class="headerlink" href="#id8" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ä¸€ä¸ª LLM çš„æ€»å‚æ•°é‡ â‰ˆ
è¯åµŒå…¥å±‚ + Transformerå±‚(Attention + FFN) + è¾“å‡ºå±‚
</pre></div>
</div>
</section>
<section id="embedding">
<h4>1.è¯åµŒå…¥å±‚ï¼ˆEmbeddingï¼‰<a class="headerlink" href="#embedding" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h4>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>è¯åµŒå…¥çŸ©é˜µå‚æ•°é‡ = V Ã— H
</pre></div>
</div>
</section>
<section id="transformer-block-n">
<h4>2.Transformer Block Ã— N å±‚<a class="headerlink" href="#transformer-block-n" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h4>
<section id="a-self-attention">
<h5>A.æ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰<a class="headerlink" href="#a-self-attention" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h5>
<ul class="simple">
<li><p>å¤šå¤´æ³¨æ„åŠ›éœ€è¦ç”Ÿæˆ Qã€Kã€V ä»¥åŠä¸€ä¸ªè¾“å‡ºæ˜ å°„ï¼š</p>
<ul>
<li><p>å¦‚æœæœ‰å¤šå¤´ attentionï¼Œé€šå¸¸ <code class="docutils literal notranslate"><span class="pre">head_dim</span> <span class="pre">Ã—</span> <span class="pre">num_heads</span> <span class="pre">=</span> <span class="pre">hidden_size</span></code></p></li>
<li><p>åœ¨æœªä½¿ç”¨GQAæ—¶ï¼ŒAttentionå‚æ•°åªä¸hidden_sizeæœ‰å…³ï¼Œä¸head_dim Ã— num_headsæ— å…³ã€‚</p></li>
</ul>
</li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Attentionå‚æ•° = 3 Ã— H Ã— H  ï¼ˆQ, K, V æƒé‡ï¼‰
              + H Ã— H      ï¼ˆè¾“å‡ºæŠ•å½±ï¼‰
    = 4 Ã— HÂ²
</pre></div>
</div>
<ul class="simple">
<li><p>æ³¨æ„ï¼šä½¿ç”¨ GQA å‚è§åé¢</p></li>
</ul>
</section>
<section id="b-feed-forward-network-ffn">
<h5>B.å‰é¦ˆç½‘ç»œï¼ˆFeed-Forward Network, FFNï¼‰<a class="headerlink" href="#b-feed-forward-network-ffn" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h5>
<ul class="simple">
<li><p>é€šå¸¸ç»“æ„æ˜¯ï¼š</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>hidden_size â†’ intermediate_size â†’ hidden_size
</pre></div>
</div>
<ul class="simple">
<li><p>ä¸” intermediate_size å¸¸ä¸ºï¼š</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>intermediate_size = M Ã— H ï¼ˆå¦‚ 4x æˆ– 3.5xï¼‰
</pre></div>
</div>
<ul>
<li><p>FFN ç»“æ„æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li><p>æ™®é€šç‰ˆ</p>
<ul class="simple">
<li><p>FFN éƒ¨åˆ†ä¹˜ä»¥ 3</p></li>
<li><p>è®¡ç®—å…¬å¼</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FFNå‚æ•°é‡ = H Ã— intermediate_size ï¼ˆç¬¬ä¸€å±‚ï¼‰
        + intermediate_size Ã— H ï¼ˆç¬¬äºŒå±‚ï¼‰
        = 2 Ã— H Ã— intermediate_size
</pre></div>
</div>
</li>
<li><p>ä½¿ç”¨ Gated FFNï¼ˆå¦‚ SwiGLUï¼‰ç»“æ„(å¦‚ LLaMA ç³»åˆ—)</p>
<ul class="simple">
<li><p>ä½¿ç”¨ SwiGLUï¼Œæ‰€ä»¥ FFN éƒ¨åˆ†ä¹˜ä»¥ 3</p></li>
<li><p>å› ä¸ºï¼š</p>
<ul>
<li><p>ç¬¬ä¸€å±‚ Linear è¾“å‡ºçš„ä¸æ˜¯ä¸€ä¸ªå‘é‡ï¼Œè€Œæ˜¯ ä¸¤ä¸ª intermediate_size å‘é‡æ‹¼æ¥åœ¨ä¸€èµ·</p></li>
<li><p>æ‰€ä»¥ç¬¬ä¸€å±‚çš„å‚æ•°æ˜¯ï¼š <code class="docutils literal notranslate"><span class="pre">Linear1:</span> <span class="pre">hidden_size</span> <span class="pre">Ã—</span> <span class="pre">(2</span> <span class="pre">Ã—</span> <span class="pre">intermediate_size)</span></code></p></li>
</ul>
</li>
<li><p>è®¡ç®—å…¬å¼</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FFNå‚æ•°é‡ = 3 Ã— H Ã— intermediate_size
= 3 Ã— H Ã— (M Ã— H)
= 3 Ã— M Ã— H^2
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>

##### C.æ€» Transformer å±‚å‚æ•°é‡

* å¯¹äºä½¿ç”¨ SwiGLU çš„ç»“æ„ï¼ˆå¦‚ LLaMAã€Mistralï¼‰ï¼Œæ¯å±‚ Transformer å±‚å‚æ•°é‡ï¼š

```text
params_per_layer = 4 Ã— hidden_sizeÂ²           â† Attentionéƒ¨åˆ†
                 + 3 Ã— hidden_size Ã— ffn_dim  â† FFNéƒ¨åˆ†
</pre></div>
</div>
<ul class="simple">
<li><p>L å±‚æ€»å‚æ•°é‡ï¼š</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>transformer_params = L Ã— params_per_layer
</pre></div>
</div>
</section>
</section>
<section id="lm-head">
<h4>3.è¾“å‡ºå±‚ï¼ˆLM Headï¼‰<a class="headerlink" href="#lm-head" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h4>
<p>ç»“æ„ä¸ embedding ç±»ä¼¼ï¼š</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>è¾“å‡ºå±‚å‚æ•° = vocab_size Ã— hidden_size
</pre></div>
</div>
<ul class="simple">
<li><p>å¦‚æœå…±äº«æƒé‡ï¼ˆweight tyingï¼Œè¾“å‡ºå±‚ = embedding æƒé‡ï¼‰ï¼Œè¿™éƒ¨åˆ†å‚æ•°å¯çœç•¥ã€‚</p></li>
</ul>
</section>
</section>
<section id="mistral-7b">
<h3>ç¤ºä¾‹ï¼šMistral 7B å‚æ•°è®¡ç®—<a class="headerlink" href="#mistral-7b" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul class="simple">
<li><p>å‚æ•°</p>
<ul>
<li><p>hidden_size = 4096</p></li>
<li><p>vocab_size = 32000</p></li>
<li><p>num_layers = 32</p></li>
<li><p>ffn_dim = 14336 = 3.5 Ã— hidden_size</p></li>
</ul>
</li>
<li><p>1.è¯åµŒå…¥å±‚</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>embedding = 32000 Ã— 4096 = 131M
</pre></div>
</div>
<ul class="simple">
<li><p>2.Transformer æ€»å‚æ•°</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>æ¯å±‚ = 4 Ã— 4096Â² + 3 Ã— 4096 Ã— 14336
    = 4096Â² Ã— (4 + 3 Ã— 3.5)
    = 4096Â² Ã— 14.5
    = 232M
32 å±‚ = 32 Ã— 232M = 7.25B
</pre></div>
</div>
<ul>
<li><p>å…¶ä¸­</p>
<ul class="simple">
<li><p>Self-Attentionå‚æ•°ä¸º</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>æ¯å±‚ = 4 Ã— 4096Â²
    = 64M
32å±‚ = 32 Ã— 64M = 2B
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><p>å®é™…ä¸­ç¨å¤šï¼Œå› ä¸ºè¿˜æœ‰ LayerNorm ç­‰å°‘é‡åç½®é¡¹ï¼Œä½†å¯ä»¥å¿½ç•¥</p>
</div></blockquote>
<ul class="simple">
<li><p>3.è¾“å‡ºå±‚</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>= 32000 Ã— 4096 = 131Mï¼ˆå¦‚æœä¸ weight tieï¼‰
</pre></div>
</div>
<ul class="simple">
<li><p>4.æ€»è®¡ï¼š</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>131M + 7.25B + 131M â‰ˆ 7.51B ï¼ˆä»…è¿‘ä¼¼ï¼‰
</pre></div>
</div>
<ul class="simple">
<li><p>ä½†æ˜¯å®é™… Mistral 7B æ˜¯ 7.2Bï¼Œå› ä¸ºï¼š</p>
<ul>
<li><p>ä½¿ç”¨äº†å¤šç»„ Attentionï¼ˆgrouped QKVï¼‰</p></li>
<li><p>æ›´å¤šç»†èŠ‚ä¼˜åŒ–ï¼ˆRMSNormï¼Œbiasï¼Œrotary embedding ç­‰ï¼‰</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="gqa">
<h2>ğŸ“Œ ä½¿ç”¨GQAæ—¶çš„å‚æ•°è®¡ç®—<a class="headerlink" href="#gqa" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h2>
<section id="id9">
<h3>å®šä¹‰ï¼šGQA æ˜¯ä»€ä¹ˆ<a class="headerlink" href="#id9" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul>
<li><p>GQA: Grouped Query Attention(åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›)</p></li>
<li><p>åœ¨æ ‡å‡†å¤šå¤´æ³¨æ„åŠ›ï¼ˆMulti-Head Attentionï¼ŒMHAï¼‰ä¸­ï¼š</p>
<ul>
<li><p>æ¯ä¸ª head éƒ½æœ‰è‡ªå·±çš„ä¸€å¥— Qï¼ˆæŸ¥è¯¢ï¼‰ã€Kï¼ˆé”®ï¼‰ã€Vï¼ˆå€¼ï¼‰ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Q_head_i = X Ã— W_q_i
K_head_i = X Ã— W_k_i
V_head_i = X Ã— W_v_i
</pre></div>
</div>
</li>
<li><p>å‚æ•°è¯´æ˜</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ç¬¦å·</p></th>
<th class="head"><p>å«ä¹‰</p></th>
<th class="head"><p>ç»´åº¦</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">X</span></code></p></td>
<td><p>å½“å‰ token çš„è¡¨ç¤ºï¼ˆè¾“å…¥å¼ é‡ï¼‰</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[T,</span> <span class="pre">H]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">W_q_i</span></code></p></td>
<td><p>ç¬¬ i ä¸ªå¤´çš„ Query æŠ•å½±çŸ©é˜µ</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[H,</span> <span class="pre">head_dim]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">W_k_i</span></code></p></td>
<td><p>ç¬¬ i ä¸ªå¤´çš„ Key æŠ•å½±çŸ©é˜µ</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[H,</span> <span class="pre">head_dim]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">W_v_i</span></code></p></td>
<td><p>ç¬¬ i ä¸ªå¤´çš„ Value æŠ•å½±çŸ©é˜µ</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[H,</span> <span class="pre">head_dim]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Q_head_i</span></code></p></td>
<td><p>ç¬¬ i ä¸ªå¤´çš„ Query å‘é‡</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[T,</span> <span class="pre">head_dim]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">K_head_i</span></code></p></td>
<td><p>ç¬¬ i ä¸ªå¤´çš„ Key å‘é‡</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[T,</span> <span class="pre">head_dim]</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">V_head_i</span></code></p></td>
<td><p>ç¬¬ i ä¸ªå¤´çš„ Value å‘é‡</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[T,</span> <span class="pre">head_dim]</span></code></p></td>
</tr>
</tbody>
</table>
</li>
<li><p>è€Œåœ¨ GQA ä¸­ï¼š</p>
<ul class="simple">
<li><p>æ¯ä¸ª head æœ‰è‡ªå·±çš„ Qï¼ˆQueryï¼‰</p></li>
<li><p>ä½†å¤šä¸ª head å…±äº«åŒä¸€ç»„ K å’Œ V</p></li>
</ul>
</li>
<li><p>ç¤ºä¾‹ï¼š</p>
<ul class="simple">
<li><p>å¦‚æœ</p>
<ul>
<li><p>æ¨¡å‹æ€»å…±æœ‰ 32 ä¸ª Attention heads</p></li>
<li><p>ä½¿ç”¨ GQA åˆ†æˆ <strong>8 ç»„</strong></p></li>
<li><p>æ¯ç»„ 4 ä¸ªå¤´å…±äº«ä¸€å¥— K/V</p></li>
</ul>
</li>
<li><p>é‚£ä¹ˆï¼š</p>
<ul>
<li><p>æœ‰ 32 å¥— Q æƒé‡</p></li>
<li><p>ä½†åªæœ‰ <strong>8 å¥— K æƒé‡</strong> å’Œ <strong>8 å¥— V æƒé‡</strong></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ç±»å‹</p></th>
<th class="head"><p>Q æƒé‡æ•°</p></th>
<th class="head"><p>K/V æƒé‡æ•°</p></th>
<th class="head"><p>æ€»å‚æ•°é‡</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>MHA</strong></p></td>
<td><p>32</p></td>
<td><p>32</p></td>
<td><p>Q: 4096Ã—4096, K/V: 4096Ã—4096</p></td>
</tr>
<tr class="row-odd"><td><p><strong>GQA</strong></p></td>
<td><p>32</p></td>
<td><p><strong>8</strong></p></td>
<td><p>Q: 4096Ã—4096, K/V: 4096Ã—1024</p></td>
</tr>
<tr class="row-even"><td><p><strong>MQA</strong></p></td>
<td><p>32</p></td>
<td><p><strong>1</strong></p></td>
<td><p>Q: 4096Ã—4096, K/V: 4096Ã—128</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id10">
<h3>ä¸ºä»€ä¹ˆä½¿ç”¨ GQAï¼Ÿ<a class="headerlink" href="#id10" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ol class="arabic simple">
<li><p><strong>å‡å°‘å‚æ•°æ•°é‡</strong>ï¼ˆå°¤å…¶é€‚åˆå¤§æ¨¡å‹ï¼‰</p></li>
<li><p><strong>èŠ‚çœæ˜¾å­˜å’Œå¸¦å®½</strong></p></li>
<li><p><strong>å¯¹æ¨¡å‹æ€§èƒ½å½±å“å¾ˆå°ï¼Œç”šè‡³æå‡ç¨³å®šæ€§</strong></p></li>
<li><p><strong>æ¯” MQAï¼ˆMulti-Query Attentionï¼‰æ›´çµæ´»</strong></p>
<ul class="simple">
<li><p>MQA æ˜¯ GQA çš„æç«¯ç‰ˆæœ¬ï¼Œæ‰€æœ‰ head å…±äº«åŒä¸€å¥— K/Vï¼ˆåªæœ‰ 1 å¥—ï¼‰</p></li>
</ul>
</li>
</ol>
</section>
<section id="id11">
<h3>GQA åœ¨å‚æ•°è®¡ç®—ä¸­çš„ä½“ç°<a class="headerlink" href="#id11" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul class="simple">
<li><p>æ–°å¢å‚æ•°</p>
<ul>
<li><p>n_head:Attention head æ•°</p></li>
<li><p>n_head_kv: K/Vçš„Attention head æ•°</p></li>
<li><p>group_size: å…±äº«ä¸€å¥— K/V Group çš„æ•°é‡</p></li>
<li><p>d_head: æ¯ä¸ª head çš„ç»´åº¦</p></li>
</ul>
</li>
<li><p>å‚æ•°å…³ç³»</p>
<ul>
<li><p>H = d_head * n_head</p></li>
<li><p>n_head = n_head_kv * group_size</p></li>
</ul>
</li>
<li><p>å…¬å¼</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># å•å±‚ Self Attention å‚æ•°è®¡ç®—
= H*d_head*n_head + H*d_head*n_head_kv*2 + H*d_head * n_head)
= 2* H^2 + 2*H*d_head*n_head_kv
= 2*H^2 + 2H^2/group_size
= H^2 (2 + 2/group_size)
</pre></div>
</div>
</section>
<section id="id12">
<h3>ç¤ºä¾‹è®²è§£â€”â€”ä»¥ä¸Šé¢çš„ Mistral 7B ç¤ºä¾‹åˆ†æ<a class="headerlink" href="#id12" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul class="simple">
<li><p>è¯´æ˜ï¼šä¸å‰é¢ç¤ºä¾‹ç›¸æ¯”ï¼Œåªæœ‰è®¡ç®— Self Attention çš„å‚æ•°é‡ä¸åŒ</p></li>
<li><p>å‚æ•°</p>
<ul>
<li><p>H = 4096</p></li>
<li><p>n_head = 32</p></li>
<li><p>n_head_kv = 8</p></li>
<li><p>group_size = 4</p></li>
<li><p>d_head = 128</p></li>
<li><p>L = 32</p></li>
</ul>
</li>
<li><p>è®¡ç®—</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>å•å±‚Self Attention å‚æ•°é‡
    = H^2 (2 + 2/group_size)
    = (4096 Ã— 4096) Ã— (2 + 2/4)
    = 40M
32å±‚Self Attention å‚æ•°é‡
    = 32 * 40M
    = 1.25G
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">å¤‡æ³¨</p>
<p>ç›¸æ¯”ä¸ç”¨ GQA, self attention çš„å‚æ•°é‡ä» <strong>2G</strong> é™ä½åˆ° <strong>1.25G</strong></p>
</div>
</section>
</section>
<section id="qwen2-5-3b">
<h2>ç¤ºä¾‹-Qwen2.5-3B<a class="headerlink" href="#qwen2-5-3b" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h2>
<section id="id13">
<h3>æ¨¡å‹ç»“æ„<a class="headerlink" href="#id13" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Qwen2ForCausalLM</span><span class="p">(</span>
  <span class="p">(</span><span class="n">model</span><span class="p">):</span> <span class="n">Qwen2Model</span><span class="p">(</span>
    <span class="p">(</span><span class="n">embed_tokens</span><span class="p">):</span> <span class="n">Embedding</span><span class="p">(</span><span class="mi">151936</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
    <span class="p">(</span><span class="n">layers</span><span class="p">):</span> <span class="n">ModuleList</span><span class="p">(</span>
      <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="mi">35</span><span class="p">):</span> <span class="mi">36</span> <span class="n">x</span> <span class="n">Qwen2DecoderLayer</span><span class="p">(</span>
        <span class="p">(</span><span class="n">self_attn</span><span class="p">):</span> <span class="n">Qwen2Attention</span><span class="p">(</span>
          <span class="p">(</span><span class="n">q_proj</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="p">(</span><span class="n">k_proj</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="p">(</span><span class="n">v_proj</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="p">(</span><span class="n">o_proj</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">mlp</span><span class="p">):</span> <span class="n">Qwen2MLP</span><span class="p">(</span>
          <span class="p">(</span><span class="n">gate_proj</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">11008</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
          <span class="p">(</span><span class="n">up_proj</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">11008</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
          <span class="p">(</span><span class="n">down_proj</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">11008</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
          <span class="p">(</span><span class="n">act_fn</span><span class="p">):</span> <span class="n">SiLU</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">input_layernorm</span><span class="p">):</span> <span class="n">Qwen2RMSNorm</span><span class="p">((</span><span class="mi">2048</span><span class="p">,),</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span>
        <span class="p">(</span><span class="n">post_attention_layernorm</span><span class="p">):</span> <span class="n">Qwen2RMSNorm</span><span class="p">((</span><span class="mi">2048</span><span class="p">,),</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">norm</span><span class="p">):</span> <span class="n">Qwen2RMSNorm</span><span class="p">((</span><span class="mi">2048</span><span class="p">,),</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span>
    <span class="p">(</span><span class="n">rotary_emb</span><span class="p">):</span> <span class="n">Qwen2RotaryEmbedding</span><span class="p">()</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="n">lm_head</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">151936</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id14">
<h3>å‚æ•°åˆ†æ<a class="headerlink" href="#id14" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul class="simple">
<li><p>H: 2048</p></li>
<li><p>V: 151936</p></li>
<li><p>L: 36</p></li>
<li><p>ffn_hidden: 11008</p></li>
<li><p>M: 11008/2048=5.375</p></li>
<li><p>K/Vçš„ out_features: 256</p></li>
<li><p>æŸ¥ config.json æ–‡ä»¶</p>
<ul>
<li><p>num_heads = 16</p></li>
<li><p>num_KV_heads = 2  (GQA æœºåˆ¶ï¼Œè¡¨ç¤ºåªç”¨ 2 ä¸ª key/value å¤´ï¼ŒèŠ‚çœ KV-cache å¼€é”€)</p></li>
</ul>
</li>
<li><p>åˆ™</p>
<ul>
<li><p>head_dim = 2048 / 16 = 128  (æ¯ä¸ª head æ˜¯ 128 ç»´)</p></li>
<li><p>num_group = 256 / 2 = 128</p></li>
<li><p>group_size: ä¸€ä¸ªkvç»„æœ‰8(=16/2)ä¸ªquery head</p></li>
</ul>
</li>
</ul>
</section>
<section id="id15">
<h3>å‚æ•°è®¡ç®—<a class="headerlink" href="#id15" title="æ­¤æ ‡é¢˜çš„æ°¸ä¹…é“¾æ¥">Â¶</a></h3>
<ul class="simple">
<li><p>è¯åµŒå…¥å±‚: 151936 Ã— 2048 = 311,205,888 = 296.75M</p></li>
<li><p>Transformer Block</p>
<ul>
<li><p>Attention æ¨¡å—: L * H^2 (2 + 2/group_size)</p>
<ul>
<li><p>= 36 * 2048^2 * (2 + 2/2)</p></li>
<li><p>= 324M</p></li>
</ul>
</li>
<li><p>FFN æ¨¡å—: L Ã— 3 Ã— M Ã— H^2</p>
<ul>
<li><p>= 36 Ã— 3 Ã— 5.375 Ã— 2048^2</p></li>
<li><p>= 2322M</p></li>
</ul>
</li>
</ul>
</li>
<li><p>è¾“å‡ºå±‚: 151936 Ã— 2048 = 296.75M</p></li>
<li><p>æ€»è®¡ç®—: 2322M + 324M +296.75M*2</p>
<ul>
<li><p>= 3.16G</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="calc_TOPS.html" class="btn btn-neutral float-right" title="TOPSè®¡ç®—" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="normal.html" class="btn btn-neutral" title="é€šç”¨" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>
  
  <div id="gitalk-container"></div>
  <div role="contentinfo">
    <p>
        &copy; Copyright 2010-2025, æ–°æºª-gordon.

    </p>
  </div>
  <div>å¤‡æ¡ˆå· <a href="http://www.beian.miit.gov.cn">äº¬ICPå¤‡16018553å·</a></div><div>Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a></div>. 


</footer>

<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?042289284b8eb33866001347a3e0b129";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>     
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'V2025.11',
            LANGUAGE:'zh-CN',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/sphinx_highlight.js"></script>
      <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
      <script type="text/javascript" src="../../_static/copybutton.js"></script>
      <script type="text/javascript" src="../../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });


      // var gitalk = new Gitalk({
      //         clientID: '565177626b5d46427009',
      //         clientSecret: 'b2a36e67e1d2a73e43667f46d571c2624f8e1026',
      //         repo: 'knowledge',
      //         owner: 'zhaoweiguo',
      //         admin: ['zhaoweiguo'],
      //         id: location.pathname,      // Ensure uniqueness and length less than 50
      //         distractionFreeMode: false  // Facebook-like distraction free mode
      //       })
      // gitalk.render('gitalk-container')

  </script>


<script type="text/javascript" src="../../_static/js/table-of-contents-sidebar.js"></script>
<!-- <script type="text/javascript" src="https://table-of-contents-sidebar.github.io/table-of-contents-sidebar-lib/table-of-contents-sidebar.js"></script> -->
<script type="text/javascript">
    window.onload = function(e){
        TableOfContents.init({
            basePath: "https://table-of-contents-sidebar.github.io/table-of-contents-sidebar-lib/",
            querySelector: "body" // or other css querySelector
        });
    }
</script> 

</body>
</html>