

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>


<!-- start added 2025-04-14   增加对markdown中公式的支持 -->
<script>
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
    },
    options: {
        ignoreHtmlClass: "tex2jax_ignore|mathjax_ignore",
        processHtmlClass: "tex2jax_process|mathjax_process|math|output_area"
    }
};
</script>
<script defer="defer" src="https://fastly.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- end added 2025-04-14   增加对markdown中公式的支持 -->


  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Session会话层 &mdash; 新溪-gordon V2025.07 文档</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="Routing路由层" href="emqtt_design_routing_layer.html" />
    <link rel="prev" title="Connection连接层" href="emqtt_design_connect_layer.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>
  <script src="../../../_static/js/jquery.min.js"></script>


<!-- 评论插件 gittalk start -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
<!-- 评论插件 gittalk end -->


</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> 新溪-gordon
          

          
          </a>

          
            
            
              <div class="version">
                V2025.07
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">工具</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../normal.html">开发工具</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/http.html">http请求工具</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/https/client.html">http client工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/https/server.html">http server工具</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/ssh.html">ssh工具</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/sshs/putty.html">putty</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/sshs/Tunnelier.html">Tunnelier</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/sshs/MobaXterm.html">MobaXterm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/sshs/sshs.html">sshs命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/sshs/other.html">其他</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/db.html">DB 工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/svg.html">svg文件打开工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/fileshare.html">文件共享</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/fileshares/onedriver.html">onedriver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/fileshares/restic.html">restic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../normals/fileshares/rclone.html">rclone</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/goreman.html">goreman</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/DNS.html">DNS工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/pre-commit.html">pre-commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/Reverse-Engineering.html">逆向工程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../normals/other.html">视频</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../wireshark.html">抓包工具</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../wiresharks/Wireshark.html">Wireshark命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wiresharks/Charles.html">Charles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wiresharks/Fiddler.html">Fiddler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wiresharks/HTTP-Toolkit.html">HTTP Toolkit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wiresharks/Other.html">其他</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ffmpeg.html">FFmpeg</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/normal.html">通用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/ffmpeg.html">FFmpeg</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/ffprobe.html">ffprobe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/docker.html">Docker相关</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/player.html">播放器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/web.html">网页/软件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/opensource.html">基于FFmpeg的开源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ffmpegs/practice.html">实践</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../vpn.html">VPN技术</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/normal.html">基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/proxy.html">proxy代理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/proxy/docker.html">Docker代理加速</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/proxy/github.html">github加速代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/proxy/pip.html">pip加速代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/proxy/huggingface.html">huggingface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/openvpn.html">openvpn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/website.html">关键网站</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/concept.html">定义</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/vpn_proxy.html">VPN代理技术</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/fanqiangs/normal.html">常用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_user.html">代理使用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_users/shell.html">proxy client使用</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_users/browser.html">浏览器代理</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_users/soft.html">软件</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_users/git.html">git使用隧道翻墙</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_users/ssh.html">ssh使用代理</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_users/windows.html">windows整体使用</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_ssh.html">建立代理-sshd隧道</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_sshs/ssh_linux.html">启动ssh隧道</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_sshs/ssh_windows.html">windows下操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_sshs/privoxy.html">privoxy-socks转http代理</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_soft.html">建立代理-专用软件</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_softs/shadowsock.html">Shadowsock</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_softs/outline.html">outline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_softs/V2Ray.html">V2Ray</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../vpns/fanqiangs/proxy_setup_softs/setup-ipsec-vpn.html">IPsec VPN Server</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/dnat.html">端口映射</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/dnats/ssh.html">SSH代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/dnats/sshuttle.html">sshuttle</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/ngrok.html">ngrok </a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/tool.html">各类工具</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/tools/sshuttle.html">sshuttle工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/tools/Drony.html">Drony</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/tools/Droid.html">Droid</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/oray.html">贝锐</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/orays/%E8%92%B2%E5%85%AC%E8%8B%B1.html">蒲公英</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/orays/%E8%8A%B1%E7%94%9F%E5%A3%B3.html">花生壳</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/orays/%E5%90%91%E6%97%A5%E8%91%B5.html">向日葵</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../vpns/orays/frp.html">frp: reverse proxy to acrose NAT or firewall</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../vpns/question.html">常见问题</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../net.html">网络相关工具</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../nets/NAT.html">NAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nets/cloudflare.html">cloudflare</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nets/windows.html">windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nets/tunnel.html">隧道Tunnel</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rest-api.html">REST API 客户端</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rest-apis/VSCode.html">VS Code插件-RESTClient</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rest-apis/Postman.html">Postman</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rest-apis/Apifox.html">Apifox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rest-apis/Insomnia.html">Insomnia</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tool.html">网络上好用的工具</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tools/Colab.html">Colab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tools/cron-job.html">cron-job</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tools/blog.html">博客</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../mqtt.html">MQTT 协议</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../broker_emqx.html">Emqtt的使用</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../emq_basic.html">Emqtt基本</a></li>
<li class="toctree-l3"><a class="reference internal" href="../emq_tune.html">Emqtt优化相关</a></li>
<li class="toctree-l3"><a class="reference internal" href="../emq_command.html">Emqtt使用命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../emq_config.html">Emqtt配置文件</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../configs/emqtt_config_basic.html">Emqtt配置基础</a></li>
<li class="toctree-l4"><a class="reference internal" href="../configs/emqtt_config_cluster.html">Emqtt集群配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../configs/emqtt_config_vm.html">Emqtt配置vm相关</a></li>
<li class="toctree-l4"><a class="reference internal" href="../configs/emqtt_config_log.html">Emqtt日志相关配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../configs/emqtt_config_protocol.html">MQTT 协议参数配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../configs/emqtt_config_acl.html">匿名认证与 ACL 文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="../configs/emqtt_config_other.html">Emqtt其他配置信息</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../emq_plugin.html">Emqtt插件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../emq_cluster.html">Emqtt分布集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="../emq_bridge.html">Emqtt节点桥接Bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="../emq_userguide.html">Emqtt用户指南 (User Guide)</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../emq_design.html">Emqtt架构设计 (Design)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_intro.html">前言</a></li>
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_architecture.html">架构设计</a></li>
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_connect_layer.html">Connection连接层</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Session会话层</a></li>
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_routing_layer.html">Routing路由层</a></li>
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_acl.html">认证和ACL</a></li>
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_hook.html">钩子(Hook)设计</a></li>
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_plugin.html">Plugin(插件)设计</a></li>
<li class="toctree-l4"><a class="reference internal" href="emqtt_design_ets.html">Mnesia/ETS 表设计</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../emq_version.html">Emqtt版本</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../broker_mosquitto.html">mosquitto的使用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../mosquitto/normal.html">常用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mosquitto/mosquitto_pub.html">mosquitto_pub命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mosquitto/mosquitto_sub.html">mosquitto_sub命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mosquitto/Auth.html">Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mosquitto/config.html">配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mosquitto/question.html">问题</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../broker_VerneMQ.html">VerneMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../client_Paho.html">Eclipse Paho</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../chrome.html">chrome相关</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../chromes/app.html">Chrome应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../chromes/plugin.html">chrome插件</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../chromes/plugins/normal.html">常用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../chromes/plugins/analysis.html">数据分析</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../chromes/plugins/develop.html">插件开发 </a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../chromes/tool.html">Chrome Console工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../chromes/question.html">常见问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../chromes/google_doc.html">Google文档</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">新溪-gordon</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../mqtt.html">MQTT 协议</a> &raquo;</li>
        
          <li><a href="../../broker_emqx.html">Emqtt的使用</a> &raquo;</li>
        
          <li><a href="../emq_design.html">Emqtt架构设计 (Design)</a> &raquo;</li>
        
      <li>Session会话层</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/mqtts/emqxs/designs/emqtt_design_session_layer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
  <table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><a class="reference external" href="/index.html">主页</a></p></td>
<td><p><a class="reference internal" href="../../../genindex.html"><span class="std std-ref">索引</span></a></p></td>
<td><p><a class="reference internal" href="../../../py-modindex.html"><span class="std std-ref">模块索引</span></a></p></td>
<td><p><a class="reference internal" href="../../../search.html"><span class="std std-ref">搜索页面</span></a></p></td>
</tr>
</tbody>
</table>
<section id="session">
<h1>Session会话层<a class="headerlink" href="#session" title="此标题的永久链接">¶</a></h1>
<p>会话层处理 MQTT 协议发布订阅(Publish/Subscribe)业务交互流程:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.缓存 MQTT 客户端的全部订阅(Subscription)，并终结订阅 QoS
2.处理 Qos0/1/2 消息接收与下发，消息超时重传与离线消息保存
3.飞行窗口(Inflight Window)，下发消息吞吐控制与顺序保证
4.保存服务器发送到客户端的，已发送未确认的 Qos1/2 消息
5.缓存客户端发送到服务端，未接收到 PUBREL 的 QoS2 消息
6.客户端离线时，保存持久会话的离线 Qos1/2 消息
</pre></div>
</div>
<p>The session layer processes MQTT packets received from client and delivers PUBLISH packets to client:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>A MQTT session will store the subscriptions and inflight messages in memory:
1.The Client’s subscriptions.
2.Inflight qos1/2 messages sent to the client but unacked, QoS 2 messages which have been sent to the Client, but have not been completely acknowledged.
3.Inflight qos2 messages received from client and waiting for PUBREL. QoS 2 messages which have been received from the Client, but have not been completely acknowledged.
4.All qos1, qos2 messages published to when client is disconnected.
</pre></div>
</div>
<p>MQueue and Inflight Window(消息队列与飞行窗口):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Concept of Message Queue and Inflight Window:
      |&lt;----------------- Max Len -----------------&gt;|
    -----------------------------------------------
IN -&gt; |     Messages Queue    |  Inflight Window    | -&gt; Out
      -----------------------------------------------
                              |&lt;---   Win Size  ---&gt;|

1.Inflight Window to store the messages delivered and await for PUBACK.
2.Enqueue messages when the inflight window is full.
3.If the queue is full, drop qos0 messages if store_qos0 is true, otherwise drop the oldest one.

1.飞行窗口(Inflight Window)保存当前正在发送未确认的 Qos1/2 消息
2.当客户端离线或者飞行窗口(Inflight Window)满时，消息缓存到队列
3.如果消息队列满，先丢弃 Qos0 消息或最早进入队列的消息

The larger the inflight window size is, the higher the throughput is. The smaller the window size is, the more strict the message order is.
窗口值越大，吞吐越高；窗口值越小，消息顺序越严格。
</pre></div>
</div>
<p>PacketId and MessageId（报文 ID 与消息 ID）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PacketId</span><span class="p">:</span><span class="mi">16</span><span class="n">bit</span>
<span class="n">MessageId</span><span class="p">:</span><span class="mi">128</span><span class="n">bit</span>

<span class="o">|</span>        <span class="n">Timestamp</span>       <span class="o">|</span>  <span class="n">NodeID</span> <span class="o">+</span> <span class="n">PID</span>  <span class="o">|</span>  <span class="n">Sequence</span>  <span class="o">|</span>
<span class="o">|&lt;-------</span> <span class="mi">64</span><span class="n">bits</span> <span class="o">-------&gt;|&lt;-</span> <span class="mi">16</span><span class="o">+</span><span class="mi">32</span><span class="n">bits</span> <span class="o">--&gt;|&lt;-</span> <span class="mi">16</span><span class="n">bits</span> <span class="o">-&gt;|</span>

<span class="n">The</span> <span class="n">PacketId</span> <span class="ow">and</span> <span class="n">MessageId</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">End</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">End</span> <span class="n">Message</span> <span class="n">PubSub</span> <span class="n">Sequence</span><span class="p">:</span>

<span class="n">PktId</span> <span class="o">&lt;--</span> <span class="n">Session</span> <span class="o">--&gt;</span> <span class="n">MsgId</span> <span class="o">&lt;--</span> <span class="n">Router</span> <span class="o">--&gt;</span> <span class="n">MsgId</span> <span class="o">&lt;--</span> <span class="n">Session</span> <span class="o">--&gt;</span> <span class="n">PktId</span>
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><a class="reference external" href="/index.html">主页</a></p></td>
<td><p><a class="reference internal" href="../../../genindex.html"><span class="std std-ref">索引</span></a></p></td>
<td><p><a class="reference internal" href="../../../py-modindex.html"><span class="std std-ref">模块索引</span></a></p></td>
<td><p><a class="reference internal" href="../../../search.html"><span class="std std-ref">搜索页面</span></a></p></td>
</tr>
</tbody>
</table>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="emqtt_design_routing_layer.html" class="btn btn-neutral float-right" title="Routing路由层" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="emqtt_design_connect_layer.html" class="btn btn-neutral" title="Connection连接层" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>
  
  <div id="gitalk-container"></div>
  <div role="contentinfo">
    <p>
        &copy; Copyright 2010-2025, 新溪-gordon.

    </p>
  </div>
  <div>备案号 <a href="http://www.beian.miit.gov.cn">京ICP备16018553号</a></div><div>Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a></div>. 


</footer>

<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?042289284b8eb33866001347a3e0b129";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>     
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'V2025.07',
            LANGUAGE:'zh-CN',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/sphinx_highlight.js"></script>
      <script type="text/javascript" src="../../../_static/clipboard.min.js"></script>
      <script type="text/javascript" src="../../../_static/copybutton.js"></script>
      <script type="text/javascript" src="../../../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });


      // var gitalk = new Gitalk({
      //         clientID: '565177626b5d46427009',
      //         clientSecret: 'b2a36e67e1d2a73e43667f46d571c2624f8e1026',
      //         repo: 'knowledge',
      //         owner: 'zhaoweiguo',
      //         admin: ['zhaoweiguo'],
      //         id: location.pathname,      // Ensure uniqueness and length less than 50
      //         distractionFreeMode: false  // Facebook-like distraction free mode
      //       })
      // gitalk.render('gitalk-container')

  </script>


<script type="text/javascript" src="../../../_static/js/table-of-contents-sidebar.js"></script>
<!-- <script type="text/javascript" src="https://table-of-contents-sidebar.github.io/table-of-contents-sidebar-lib/table-of-contents-sidebar.js"></script> -->
<script type="text/javascript">
    window.onload = function(e){
        TableOfContents.init({
            basePath: "https://table-of-contents-sidebar.github.io/table-of-contents-sidebar-lib/",
            querySelector: "body" // or other css querySelector
        });
    }
</script> 

</body>
</html>